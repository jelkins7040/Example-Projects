/*!
 * (c) 2010 SysIQ, Inc. All rights reserved.
 *
 * This product is protected by United States laws,
 * international copyright treaties and all other applicable
 * national or international laws.
 *
 * This software may not, in whole or in part, be copied,
 * photocopied, translated, modified, or reduced to any
 * electronic medium or machine readable form
 * without the prior written consent of SysIQ, Inc.
 *
 * Filename: sysiq.product.js
 * Author:   Artem Mitasov, Dmitry Shestopalov
 */
(function(c){minibag={showUrl:"",timer:null,inUse:false,requestAlreadySent:false,newShopAction5Tag:function(g){if(window.cmPageViewPageID=="Checkout"){return}var i=g.split("&");var f;var e={};var h=[];var d={};if(g.indexOf("Selected=")>-1){c.ajax({url:window.generalProductInfoUrl,type:"GET",dataType:"json",success:function(j){c.each(j.aggregatedProducts,function(l,k){var m="#1#-_-#2#";if(k.RebateAmount!=0&&k.RebateExclude=="N"){m=m.replace("#2#",j.coupon.code);m=m.replace("#1#",k.RebateAmount)}else{if(j.coupon.code!="null"&&k.RebateExclude=="N"){m=m.replace("#2#",j.coupon.code)}}m=m.replace("#1#","");m=m.replace("#2#","");cmCreateShopAction5Tag(k.ProductID,k.ProductName,k.Quantity,k.AggregatedPrice,k.CategoryID,m)});cmDisplayShop5s()},error:function(j){}})}else{c.ajax({url:window.generalProductInfoUrl,type:"GET",dataType:"json",success:function(j){c.each(j.aggregatedProducts,function(l,k){var m="#1#-_-#2#";if(k.RebateAmount!=0&&k.RebateExclude=="N"){m=m.replace("#2#",j.coupon.code);m=m.replace("#1#",k.RebateAmount)}else{if(j.coupon.code!="null"&&k.RebateExclude=="N"){m=m.replace("#2#",j.coupon.code)}}m=m.replace("#1#","");m=m.replace("#2#","");cmCreateShopAction5Tag(k.ProductID,k.ProductName,k.Quantity,k.AggregatedPrice,k.CategoryID,m)});cmDisplayShop5s()},error:function(j){}})}},add:function(h,f,g,d){if(!this.requestAlreadySent){var e=c(g).siblings(".addToBagProgress");var k=c(g).closest("#QuickViewPIPPopup");var i=function(p){e.hide();k.trigger("closePopup");c(window).scrollTop(0);if(p=="ERROR_PRODUCT_OFFLINE"){showProductOfflineError("The product you've requested has just run out of stock.");return}if(c("div.shoppingbag").length||c("div.checkout").length){if(c("div.shoppingbag .emptytext:visible").length){window.location=shoppingBagStartUrl}else{var n=function(u){if(u.update.state.requisition.shippingRestrictions&&u.update.state.requisition.shippingRestrictions.restrictedStates){var s=u.update.state.requisition.shippingRestrictions.restrictedStates;c.restrictedStatesList=[];for(var r=0;r<s.length;r++){c.restrictedStatesList.push(s[r])}}d&&d()};c("body").refreshLineItems(n)}}c("#minibag").html(p);if(typeof(_result_response_)!="undefined"&&_result_response_.state=="ok"&&_result_response_.uuids.length>0){var m=c("div.wishlistprod-box").find(".product-item"),l=m.length;if(m.length>0){c.each(m,function(r,s){if(~c.inArray(c(this).find("input[name=Selected]").val(),_result_response_.uuids)){--l;if(l>0){c(this).remove()}else{document.location.href=""}}})}}c("#minibag").find("a.close-mini-cart").click(function(r){r.preventDefault();minibag.close(0)});var o=c("#qtMessage").html();c("#qtMessage").remove();if(o!=null){showDialogTopPopup(o)}var q=c("input[name=BagItemsQuantity]").val();if(q!=null){c(".bagItemsQty").html(q)}minibag.newShopAction5Tag(h);minibag.init();minibag.slide()};var j=function(l){e.hide();k.trigger("closePopup")};minibag.close();e.show();c.ajax({type:"POST",url:f,data:h,success:i,error:j,complete:function(){minibag.requestAlreadySent=false}});this.requestAlreadySent=true}},init:function(){minibag.reset();c("li.minibag").bind("mouseenter",function(d){minibag.inUse=true;clearTimeout(minibag.timer);minibag.timer=null;(minibag.isShow()?"":minibag.show())}).bind("mouseleave",function(){minibag.inUse=false;clearTimeout(minibag.timer);minibag.timer=null;minibag.timer=setTimeout("minibag.close()",3000)})},isShow:function(){return c("#minibag").is(":visible")},show:function(){var d=function(f){c("#minibag").html(f);if(window.cmxEnabled&&typeof cmCreateManualLinkClickTag=="function"){c("#minibag a:has(div.viewbag)").click(function(){cmCreateManualLinkClickTag(this.href,this.name,this.name)})}c("#minibag").find("a.close-mini-cart").click(function(g){g.preventDefault();minibag.close(0)});minibag.slide()};var e=function(f){minibag.slide()};if(minibag.showUrl==""){minibag.slide();return}c.ajax({url:minibag.showUrl,success:d,error:e})},slide:function(){if(c("#minibag *").size()>0){var d=c("input[name=BagItemsQuantity]").val();if(d!=null){c(".bagItemsQty").html(d)}c("#minibag").slideDown("slow");c("li.minibag").addClass("hovering");clearTimeout(minibag.timer);minibag.timer=null;minibag.timer=setTimeout("minibag.close()",3000)}else{c(".bagItemsQty").html("(0 items)")}},reset:function(){c("li.minibag").unbind("mouseenter").unbind("mouseleave").unbind("hover");minibag.inUse=false},close:function(d){if((minibag.timer!=null&&!minibag.inUse)||d==0){clearTimeout(minibag.timer);minibag.timer=null;c("#minibag").fadeOut();c("li.minibag").removeClass("hovering")}}};var b=function(){var d=null;if(window.cm_vc){d=window.cm_vc}else{if(/[&?]search_question=([^&]+)/i.test(location.href)){d="Search"}else{if(/[&?]cm_vc=([^&]+)/i.test(location.href)){d=RegExp.$1}}}return d};var a=function(){var d=c(".addtocartbutton").live("addtocart",function(i,e){var h=c(this).parents("form:first").serialize()+"&add=";var f=b();if(!f){f=c(this).parents("form:first").find("[name=CatalogCategoryID]").val()}if(f){if(f=="Search"){h+=("&CategoryID="+f+"&cm_vc=Search")}else{h+=("&CategoryID="+f)}}var g=c(this).parents("form:first").attr("action");minibag.add(h,g,this,e);return false});return d};c(document).ready(function(){a();minibag.init()})})(jQuery);