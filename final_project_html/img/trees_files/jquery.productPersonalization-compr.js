/*!
 * (c) 2010 SysIQ, Inc. All rights reserved.
 *
 * This product is protected by United States laws,
 * international copyright treaties and all other applicable
 * national or international laws.
 *
 * This software may not, in whole or in part, be copied,
 * photocopied, translated, modified, or reduced to any
 * electronic medium or machine readable form
 * without the prior written consent of SysIQ, Inc.
 *
 * Filename: jquery.productPersonalization.js
 * Author:   Dmitry Shestopalov
 */
(function(a){var b={trueSpectraHost:"",webRoot:"",qv:"",selectors:{persCheckBox:"#personalization",persBody:"#personalizationbody",fontImgs:".personalfontimg",colorImgs:".personalizationcolor",colorSelect:"select.pcolor",fontSelect:"select.pfont",alternative:"input[name='isAlternative']",productInfo:"#product_info",alterProductInfo:"#alternative_product_info",previewPersonalizationBtn:".previewpersonalization",selectedVProdUUID:".SelectedVProdUUID:last"}};a.fn.productPersonalization=function(l){var c=a.extend({},b,l);var g=this.mapSelectors(c.selectors);var k=a(this);g.persCheckBox.bind("click",function(){var n="select[name$='_VariationProductUUID']";if(a(this).is(":checked")){if(g.alternative.val()=="true"){var m=g.productInfo.find(n);if(m.size()&&m.val()){g.alterProductInfo.find(n).val(m.val()).change()}g.alterProductInfo.show();g.productInfo.hide();var q=g.alterProductInfo.find(".cmCurrentProductID").val();var p=g.alterProductInfo.find(".cmCurrentCategoryID").val()}g.persBody.slideDown(300)}else{if(g.alternative.val()=="true"){var m=g.alterProductInfo.find(n);if(m.size()&&m.val()){g.productInfo.find(n).val(m.val()).change()}g.alterProductInfo.hide();g.productInfo.show();var q=g.productInfo.find(".cmCurrentProductID").val();var p=g.productInfo.find(".cmCurrentCategoryID").val()}g.persBody.slideUp(300)}if(q){var o=null;if(window.cm_vc){o=window.cm_vc}else{if(/[&?]cm_vc=([^&]+)/i.test(location.href)){o=RegExp.$1}}a.ajax({url:c.urls.productInformationUrl,type:"POST",data:{ProductUUID:q,CatalogCategoryID:p,cm_vc:o,mode:"save"},dataType:"json",success:function(t){var s=null;for(var r=0;r<t.products.length;r++){s=t.products[r];cmCreateProductviewTag(s.ProductID,s.ProductName,s.CategoryID,"",o)}},error:function(r){}})}});g.fontImgs.click(function(o){o.preventDefault();g.fontImgs.removeClass("active");a(this).addClass("active");var p=a(this).attr("fontname").split(",");var m=p[0];var n=p[1];k.find("select[name$='"+n+"'] option").each(function(q,r){if(a(this).text()==m){a(this).attr("selected","selected")}else{a(this).removeAttr("selected")}})});g.colorImgs.click(function(o){o.preventDefault();g.colorImgs.removeClass("active");a(this).addClass("active");var p=a(this).attr("colorname").split(",");var m=p[0];var n=p[1];k.find("select[name$='"+n+"'] option").each(function(q,r){if(a(this).text()==m){a(this).attr("selected","selected")}else{a(this).removeAttr("selected")}})});g.colorSelect.change(function(){var m=a.trim(a(this).find(":selected").text());var n=a(this).parents(".personalizationcolors").find(".personalizationcolor");n.removeClass("active");n.filter("[colorname^="+m+"]").addClass("active")});g.fontSelect.change(function(){var n=a.trim(a(this).find(":selected").text());var m=a(this).parents(".personalizationfont").find(".personalfontimg");m.removeClass("active");m.filter("[fontname^="+n.replace("[","")+"]").addClass("active")});g.previewPersonalizationBtn.click(function(){var s=a(this).closest(".prodinfo");if(k.validatePersonalizationAttr()){s.find(".errorpersonalizationymessage").hide();var n=c.trueSpectraHost+"/transparent.png?effect=text,";var m=s.find("input[name='Personalization']").val();var r=h(s,m);var o=f(s,m)!=""?d(f(s,m)):"TimesNewRoman";var p=j(s,m)!=""?j(s,m):"000000";var q;var t=function(v){return((v=parseInt(v))?v:0).toString(16).replace(/(?=^\w$)/,"0")};var u=function(x,w,v){return t(x)+t(w)+t(v)};if(/(\d+),(\d+),(\d+)/.test(p)){p=u(RegExp.$1,RegExp.$2,RegExp.$3)}a.ajax({url:c.urls.getColor,type:"POST",data:{VProdUUID:g.selectedVProdUUID.val()},dataType:"json",success:function(w){var v=w.colorBG;if(o=="DIAMOND"){q="<img src='"+c.webRoot+"/images/personalization/preview/DIAMOND_DEFAULT.JPG' />";s.find(".preview-box").html(q)}else{o=i(f(s,m));q="<img src='"+n+r+","+o+",36,"+p+",66&bgcolor="+v+"&wid="+(c.qv?"330":"444")+"&hei=66&cvt=png'>";s.find(".preview-box").html(q)}},error:function(){}})}return false});function j(m,n){var o="";m.find(".pcolor[name^='"+n+"']").each(function(q,s){if(a(this).val().length>0){var r=a(this).val();var p=a(this).val().split("CLR:");if(p.length>1){o=p[p.length-1]}}});return o}function f(n,o){var m="";n.find(".pfont[name^='"+o+"']").each(function(p,q){if(a(this).val().length>0){m+=a(this).val()}});return m}function h(m,n){var o="";m.find("*[name^='"+n+"']").each(function(q,r){if(a(this).is(".pinitial")&&a(this).val().length>0){o+=a.trim(a(this).val())}if(a(this).is(".ptext")&&a(this).val().length>0){var p=(o.length==0)?"":"%0A";o+=p+encodeURIComponent(a.trim(a(this).val())).replace(/%25/g,"%2525").replace(/%2C/g,"%252C")}});return o}function e(o){var n="";if(o!=null&&o!=""&&o.search("TH:")>0){var m=o.split("TH:");if(m.length>1){n=m[0]}}return n}function d(o){var p="";if(o!=null&&o!=""&&o.search("TH:")>0){var m=o.split("TH:");if(m.length>1){if(m[1]!=null&&m[1].search("\\|FONT:")>0){var n=m[1].split("|FONT:");if(n.length>1){p=n[0]}}else{p=m[1]}}}return p}function i(o){var n="";if(o!=null&&o!=""&&o.search("\\|FONT:")>0){var m=o.split("|FONT:");if(m.length>1){n=m[1]}}return n}}})(jQuery);